---
layout: post
title: BTRFS
category: Linux
---

#btrfs

## Особенности режима BTRFS:

- снимки создаются с использованием встроенных средств файловой системы BTRFS;

- снимки создаются и восстанавливаются мгновенно (создание снимков — это атомарная транзакция на уровне файловой системы);

- снимки восстанавливаются путём замены системных подразделов. Поскольку файлы никогда не копируются, не удаляются и не перезаписываются, риск потери данных отсутствует. Существующая система сохраняется как новый снимок после восстановления;

- снимки сохраняются на том же диске, с которого они созданы (системном диске). Хранение на других дисках не поддерживается. Если системный диск выйдет из строя, снимки, хранящиеся на нём, будут потеряны вместе с системой;

- нет возможности исключать файлы и каталоги;

- размер снимков BTRFS изначально равен нулю. При изменении системных файлов, данные записываются в новые блоки данных, которые занимают дисковое пространство (копирование при записи). Файлы в снимке продолжают указывать на исходные блоки данных;

- ОС должна быть установлена на раздел BTRFS с разбивкой на подразделы @ и @home (см. Btrfs). Другие виды разделов не поддерживаются;

- снимки можно восстановить без немедленной перезагрузки запущенной системы.

## На вкладке «Тип» выбрать тип снимков:

![](/image/Timeshift/1.Timeshift-btrfs-01.png)

`Настоятельно рекомендуется использовать моментальные снимки BTRFS в системах, установленных в разделе BTRFS.`

На вкладке «Место» указать устройство, где будут храниться снимки:

![](/image/Timeshift/2.Timeshift-btrfs-02.png)

На вкладке «Расписание» можно выбрать несколько уровней создания снимков (ежемесячно, еженедельно, ежедневно, ежечасно, при загрузке) и указать количество сохраняемых снимков для каждого уровня:

![](/image/Timeshift/3.Timeshift-btrfs-03.png)

Снимки уровня «Загрузка» создаются при каждом запуске системы (с задержкой в 10 минут). Они выполняются в фоне и не влияют на скорость загрузки системы.

Т.к. Timeshift не предназначен для резервного копирования пользовательских данных, по умолчанию домашние каталоги пользователей не включаются в резервную копию. На вкладке «Пользователи» можно включить подраздел @home в создаваемые снимки:

![](/image/Timeshift/4.Timeshift-btrfs-04.png)


## Восстановление системы

Снимки можно восстановить либо из работающей системы (оперативное восстановление), либо из другой системы, на которой установлен Timeshift (автономное восстановление).

Снимки можно восстановить, выбрав снимок в главном окне и нажав кнопку «Восстановить» на панели инструментов.

Примечание: Если основная система не загружается, то можно загрузиться с Live CD, установить Timeshift, на вкладке «Место» указать расположение снимков и восстановить снимок в основной системе:

![](/image/Timeshift/6.Timeshift-restore-01.png)

Для завершения процесса восстановления требуется перезагрузка системы.

# Работа с Timeshift в командной строке

## Вывод справки о команде:

- $ timeshift
Если параметры не указаны, например при создании снимка, значения по умолчанию будут загружены из конфигурации приложения.

## Просмотр списка снимков:

***Пример:***

- $ timeshift --list

  /dev/sda2 is mounted at: /run/timeshift/backup, options: rw,relatime,ssd,space_cache=v2,subvolid=5,subvol=/

  Device : /dev/sda2

  UUID   : 9306bd96-eaee-41d9-a65d-6385c68357d2

  Path   : /run/timeshift/backup

  Mode   : BTRFS

  Status : OK

  5 snapshots, 107.4 GB free


Num     Name                 Tags  Description                             

0    >  2021-12-28_16-56-22  O                                             
1    >  2021-12-28_17-01-26  O                                             
2    >  2021-12-29_08-48-49  O                                             
3    >  2021-12-29_15-40-02  O D                                           
4    >  2021-12-29_15-41-48  O     Before restoring '2021-12-28 17:01:26'

## Создание снимка:

- $ timeshift --create

***Пример:***

- $ timeshift --create --comments "after update" --tags D

  Using system disk as snapshot device for creating snapshots in BTRFS mode

  /dev/sda2 is mounted at: /run/timeshift/backup, options: rw,relatime,ssd,space_cache=v2,subvolid=5,subvol=/

  Creating new backup...(BTRFS)

  Saving to device: /dev/sda2, mounted at path: /run/timeshift/backup

  Created directory: /run/timeshift/backup/timeshift-btrfs/snapshots/
  2021-12-29_16-06-38

  Created subvolume snapshot: /run/timeshift/backup/timeshift-btrfs/snapshots/2021-12-29_16-06-38/@

  Created control file: /run/timeshift/backup/timeshift-btrfs/snapshots/2021-12-29_16-06-38/info.json

  BTRFS Snapshot saved successfully (0s)

  Tagged snapshot '2021-12-29_16-06-38': ondemand

## Создание снимка, если он запланирован (есть в расписании):

- $ timeshift --check

## Восстановить снимок (параметры будут запрошены в интерактивном режиме):

- $ timeshift --restore

## Восстановить снимок:

- $ timeshift --restore --snapshot '2021-12-28_17-01-26'

## Восстановить определенный снимок в необходимый раздел (для rsync):

- $ timeshift --restore --snapshot 1 --target /dev/sda2

## Удалить снимок:

- $ timeshift --delete --snapshot '2021-12-28_17-01-26'



